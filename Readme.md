# STM32F4 Makefile for STCubeMX-based projects

### What is necessary

### Tools and software requirements

* [STCubeMX](http://www.st.com/en/development-tools/stm32cubemx.html) graphical utility provided from ST. Useful to generate a first code with already-written initialization routines (GPIO, ADC, SysClock...);

* [GCC ARM Embedded toolchain](https://launchpad.net/gcc-arm-embedded) for ARM Cortex-M. You need this in order to compile and debug your code. You can download pre-built binaries for all major operating systems. On mostly all Linux Distros it can be downloaded through package manager (apt-get, yum, pacman...). Is useful to download also GDB ARM Debugger;

* [stlink](https://github.com/texane/stlink) utility written by texane. You need this for flashing the compiled code to the board. It also contains a gdb server used to debug your code on the chip. Install this from the source code or if you are on OS X, you can do it from brew: ```brew install stlink```;

* make. You need this in order to... make this project. make should be pre-installed on all Linux and OS X machines.

### Usage

1. Download and install the requirements mentioned above;
2. Download or clone this repository, or simply copy-and-paste the Makefile;
3. Edit the Makefile if needed. More detailed infos below;
4. Open STCubeMX and create a new project. Configure CPU as you want, then generate the code;
5. Copy the Makefile in the root directory of your projectM
6. Open a terminal in project folder, then type `make`M
7. Connect the stm32f4 discovery board to your computer;
8. If you just want to flash your program, type `make flash`;
9. If you want to debug the program:
   1. Type `make debug`.
   2. It will be asked to start st-util (gdb server included in the stlink). Open a new terminal window and type `st-util`.
   3. Go back in the gdb window and press a key. gdb will connect to localhost port 4242, where st-util is listening. From this point on, st-util will take commands from gdb and control the CPU.
   4. Type `break main` to set up a break point to the main.
   function.
   5. Type `continue`. The program will resume the execution.
   5. Have fun.

### Editing Makefile

In mostly all cases only a few lines of this file need to be edited:
* `PROJ_NAME` - Must be the same of the project name generated by STCube;
* `CPU_` variables - All the possible names of the CPU (in UpperCase and LowerCase). They can be get from STCube (or reading on the CPU).

### Changelog
2016-10-29 - Forked repo. Edited to work out-of-the-box with STCubeMX. Added some variables to make it easily adaptable with large number of ST CPU. Edited compilation command. Added st-utils autostart.

### Bibliography

* [sferrini](https://github.com/sferrini): this makefile is a fork of his work;
* [StackOverflow Post](http://stackoverflow.com/questions/19419782/exit-c-text0x18-undefined-reference-to-exit-when-using-arm-none-eabi-gcc): helped to solve some compilation errors. Added option --specs=nosys.specs
